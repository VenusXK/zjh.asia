# 服务器环境配置

实现环境为 Ubuntu 22 版本。

## git 配置 Github SSH

配置 git 的本地用户名和密码，生成 ssh 密钥

```shell
# 配置git的全局用户名和密码
git config --global user.name "jinghe_zhang"
git config --global user.email "jinghe_zhang@hotmail.com"

# 生成ssh密钥
ssh-keygen -t rsa -C "jinghe_zhang@hotmail.com"
```

查看 `/root/.ssh/id_rsa.pub` 中的内容。

```shell
cat /root/.ssh/id_rsa.pub
```

将内容复制到 [Github: Add new SSH](https://github.com/settings/ssh/new)

执行克隆后，自动绑定 SSH，如下：

```shell
root@iZbp1cyybhwcd5m9i4584dZ:/home/www# git clone git@github.com:VenusXK/zjh.asia.git
Cloning into 'zjh.asia'...
The authenticity of host 'github.com (20.205.243.166)' can't be established.
ED25519 key fingerprint is SHA256:+DiY3wvvV6TuJJhbpZisF/zLDA0zPMSvHdkr4UvCOqU.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'github.com' (ED25519) to the list of known hosts.
remote: Enumerating objects: 2154, done.
remote: Counting objects: 100% (225/225), done.
remote: Compressing objects: 100% (150/150), done.
remote: Total 2154 (delta 70), reused 181 (delta 39), pack-reused 1929
Receiving objects: 100% (2154/2154), 24.68 MiB | 4.85 MiB/s, done.
Resolving deltas: 100% (974/974), done.
```

## nodejs 等配置

### 更新 apt

```shell
apt update
```

### nodejs 安装及报错处理

使用 n 安装 nodejs，如下：

```shell
apt install npm
npm install -g n
n stable
```

::: danger 废弃的方法
```shell
apt install nodejs
```

此方法安装会导致 nodejs 版本过低。
:::

### yarn 安装及报错处理

安装 yarn 包管理软件

```shell
npm install yarn -g
```

#### 报错1：`yarn install` 提示 nodejs 版本过老

```shell
yarn install v1.22.21
warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.
[1/4] Resolving packages...
[2/4] Fetching packages...
error @rollup/plugin-alias@5.0.0: The engine "node" is incompatible with this module. Expected version ">=14.0.0". Got "12.22.9"
error Found incompatible module.
info Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.
```

用 n 升级 nodejs，方法如下：

```shell
npm install -g n
n stable
```

## nginx 配置

使用 apt 安装 nginx

```shell
apt install nginx
```

### 配置 nginx 配置文件

Linux 下查询程序位置，使用 `whereis <程序名称>`，输入 `whereis nginx` 返回结果如下：

```shell
 /usr/sbin/nginx
 /usr/lib/nginx  
 /etc/nginx // [!code hl]
 /usr/share/nginx
 /usr/share/man/man8/nginx.8.gz
```

`/etc/nginx/` 目录下结构如下：

```shell
conf.d        fastcgi_params  koi-win     modules-available  nginx.conf    scgi_params      sites-enabled  uwsgi_params
fastcgi.conf  koi-utf         mime.types  modules-enabled    proxy_params  sites-available  snippets       win-utf
```

> Nginx 的主配置文件是 nginx.conf，这个配置文件一共由三部分组成，分别为**全局块**、**events 块**和 **http 块**。http 块又包含 http 全局块、多个 server 块。每个 server 块中，可以包含 server 全局块和多个 location 块。在同一配置块中嵌套的配置块，各个之间不存在次序关系。

在该 config 文件中，可以看到其引用了两个其他文件。

```shell
include /etc/nginx/conf.d/*.conf;
include /etc/nginx/sites-enabled/*;
```

在 `/etc/nginx/sites-available/default` 文件中有 nginx 指向的目录文件，修改 `root` 根属性即可。

修改后，成功通过 `http` 进行站点访问。

### nginx 配置 https

参考教程 [Nginx或Tengine服务器配置SSL证书](https://help.aliyun.com/zh/ssl-certificate/user-guide/install-ssl-certificates-on-nginx-servers-or-tengine-servers)。

在阿里云 SSL 页面申请免费的 SSL 证书，下载 `pem/key` 格式的 nginx 证书。CSR生成方式为 `系统生成或选择已有的CSR` 时，证书压缩包包含的文件如下：

- **证书文件（PEM格式）**：Nginx支持安装PEM格式的文件，PEM格式的证书文件是采用Base64编码的文本文件，且包含完整证书链；
- **私钥文件（KEY格式）**：默认以证书绑定域名命名。

将证书文件和私钥文件上传到 Nginx 服务器的证书目录(自行创建)，我这里为 `/etc/nginx/cert`，把证书传到 oss 对象存储服务器上，再使用 `wget` 命令获取证书。

编辑 Nginx 配置文件 `/etc/nginx/sites-available/default`，修改与证书相关的配置，在 nginx.conf 中定位到 server 属性配置，SSL 设置那里参考如下模板进行修改。

```shell
server {
    SSL configuration

    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;

    ssl_certificate /etc/nginx/cert/zjh.asia.pem;
    ssl_certificate_key /etc/nginx/cert/zjh.asia.key;

    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;

    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;

    ssl_prefer_server_ciphers on;
}
server {
    listen 80;
    listen [::]:80;

    server_name zjh.asia;

    rewrite ^(.*)$ https://$host$1;
    root /home/www/doploy.zjh.asia/;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}
```

执行以下命令，重启Nginx服务。

```shell
nginx -s reload  #重新载入配置文件。
```

证书安装完成后，可通过访问证书的绑定域名验证该证书是否安装成功。
